diff -up openssl-0.9.7a/crypto/engine/hw_ubsec.c.wexpand openssl-0.9.7a/crypto/engine/hw_ubsec.c
--- openssl-0.9.7a/crypto/engine/hw_ubsec.c.wexpand	2010-02-10 13:01:47.000000000 +0100
+++ openssl-0.9.7a/crypto/engine/hw_ubsec.c	2010-04-01 14:48:40.000000000 +0200
@@ -454,6 +454,7 @@ static int ubsec_init(ENGINE *e)
 err:
 	if(ubsec_dso)
 		DSO_free(ubsec_dso);
+	ubsec_dso = NULL;
 	p_UBSEC_ubsec_bytes_to_bits = NULL;
 	p_UBSEC_ubsec_bits_to_bytes = NULL;
 	p_UBSEC_ubsec_open = NULL;
@@ -924,7 +925,7 @@ static int ubsec_dh_generate_key (DH *dh
                 priv_key = BN_new();
                 if (priv_key == NULL) goto err;
                 priv_key_len = BN_num_bits(dh->p);
-                bn_wexpand(priv_key, dh->p->top);
+                if (bn_wexpand(priv_key, dh->p->top) == NULL) goto err;
                 do
                         if (!BN_rand_range(priv_key, dh->p)) goto err;
                 while (BN_is_zero(priv_key));
@@ -939,7 +940,7 @@ static int ubsec_dh_generate_key (DH *dh
                 {
                 pub_key = BN_new();
                 pub_key_len = BN_num_bits(dh->p);
-                bn_wexpand(pub_key, dh->p->top);
+                if(bn_wexpand(pub_key, dh->p->top) == NULL) goto err;
                 if(pub_key == NULL) goto err;
                 }
         else
